<!DOCTYPE html>
<html>
<head>
    <title>M3U Playlist Manager v4</title>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body { font-family: Arial; max-width: 900px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #333; }
        .url-box { background: #f0f0f0; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .url-box code { background: #fff; padding: 10px; display: block; word-break: break-all; }
        .token-box { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border: 2px solid #ffc107; }
        .token-box input { width: 60%; padding: 10px; margin-right: 10px; font-size: 14px; }
        .paste-box { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; border: 2px solid #2196F3; }
        .paste-box textarea { width: 100%; padding: 10px; min-height: 100px; font-family: monospace; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #4CAF50; color: white; }
        .btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; font-size: 14px; }
        .btn:hover { background: #45a049; }
        .btn-secondary { background: #2196F3; }
        .btn-secondary:hover { background: #0b7dda; }
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #da190b; }
        input[type="text"], input[type="password"] { padding: 8px; box-sizing: border-box; }
        .help-text { color: #666; font-size: 0.9em; margin-top: 8px; }
        .status { padding: 12px; margin: 10px 0; border-radius: 5px; font-weight: bold; font-size: 14px; }
        .status.success { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .status.error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .version { position: fixed; bottom: 10px; right: 10px; background: #333; color: white; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; }
    </style>
</head>
<body>
    <h1>üé¨ M3U Playlist Manager v4.0</h1>
    
    <div class="url-box">
        <strong>Your M3U Playlist URL:</strong>
        <code>https://wizzzzard333-ctrl.github.io/m3u-playlist/playlist.m3u</code>
    </div>

    <div class="token-box">
        <strong>üîë GitHub Token Storage (PERMANENT):</strong><br><br>
        <input type="password" id="tokenInput" placeholder="Paste your GitHub Personal Access Token here">
        <button class="btn btn-secondary" onclick="saveToken()">üíæ SAVE TOKEN</button>
        <button class="btn btn-danger" onclick="clearToken()">üóëÔ∏è CLEAR</button>
        <div id="tokenStatus" style="margin-top: 10px;"></div>
        <div class="help-text">
            <strong>Setup:</strong> <a href="https://github.com/settings/tokens/new" target="_blank">Create Token</a> ‚Üí 
            Select <strong>"repo"</strong> scope ‚Üí Generate ‚Üí Copy ‚Üí Paste above ‚Üí Click SAVE TOKEN
        </div>
    </div>

    <div class="paste-box">
        <strong>üìã Bulk Add Videos:</strong><br>
        <textarea id="pasteArea" placeholder="Paste video URLs here (one per line)

Examples:
https://example.com/video1.mp4
https://example.com/video2.mp4

With custom titles:
My Video | https://example.com/video.mp4
Tutorial | https://example.com/tutorial.mp4"></textarea>
        <button class="btn btn-secondary" onclick="addFromClipboard()">‚ûï ADD ALL URLS</button>
        <div class="help-text">Paste URLs (one per line). Optional: "Title | URL" format</div>
    </div>

    <h2>üìπ Video List</h2>
    <table id="videoTable">
        <thead>
            <tr>
                <th style="width: 30%;">Title</th>
                <th style="width: 55%;">URL</th>
                <th style="width: 15%;">Action</th>
            </tr>
        </thead>
        <tbody id="videoList"></tbody>
    </table>

    <button class="btn" onclick="addRow()">‚ûï Add Single Video</button>
    <button class="btn" onclick="saveVideos()" style="font-size: 16px; padding: 12px 24px;">üíæ SAVE & UPDATE PLAYLIST</button>

    <div class="version">v4.0 STABLE</div>

    <script>
        // Configuration
        const CONFIG = {
            GITHUB_USER: 'wizzzzard333-ctrl',
            REPO: 'm3u-playlist',
            FILE: 'videos.json',
            BRANCH: 'main',
            TOKEN_KEY: 'M3U_GITHUB_TOKEN_V4_FINAL',
            VERSION: '4.0'
        };
        
        // State
        let STATE = {
            videos: [],
            fileSha: '',
            token: null
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            console.log('%c=== M3U Playlist Manager v4.0 ===', 'color: green; font-size: 16px; font-weight: bold;');
            initToken();
            loadVideos();
        });

        function initToken() {
            try {
                STATE.token = localStorage.getItem(CONFIG.TOKEN_KEY);
                
                if (STATE.token && STATE.token.length > 20) {
                    document.getElementById('tokenInput').value = STATE.token;
                    showStatus('‚úÖ TOKEN LOADED! Ready to save videos.', 'success');
                    console.log('%c‚úì Token found in localStorage', 'color: green;');
                } else {
                    showStatus('‚ö†Ô∏è NO TOKEN SAVED. Please paste and save your GitHub token.', 'error');
                    console.log('%c‚úó No token found', 'color: red;');
                }
            } catch (e) {
                console.error('Token init error:', e);
                showStatus('‚ùå Error loading token: ' + e.message, 'error');
            }
        }

        function showStatus(message, type) {
            const div = document.getElementById('tokenStatus');
            div.className = 'status ' + type;
            div.innerHTML = message;
        }

        function saveToken() {
            try {
                const token = document.getElementById('tokenInput').value.trim();
                
                if (!token || token.length < 20) {
                    showStatus('‚ùå Invalid token. Must be at least 20 characters.', 'error');
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem(CONFIG.TOKEN_KEY, token);
                STATE.token = token;
                
                // Verify save
                const verify = localStorage.getItem(CONFIG.TOKEN_KEY);
                if (verify === token) {
                    showStatus('‚úÖ TOKEN SAVED PERMANENTLY! You can now save videos anytime.', 'success');
                    console.log('%c‚úì Token saved successfully', 'color: green; font-weight: bold;');
                    console.log('Storage key:', CONFIG.TOKEN_KEY);
                    console.log('Token length:', token.length);
                } else {
                    throw new Error('Verification failed');
                }
            } catch (e) {
                console.error('Save error:', e);
                showStatus('‚ùå Failed to save: ' + e.message, 'error');
            }
        }

        function clearToken() {
            if (!confirm('Clear saved token?')) return;
            
            try {
                localStorage.removeItem(CONFIG.TOKEN_KEY);
                STATE.token = null;
                document.getElementById('tokenInput').value = '';
                showStatus('‚úÖ Token cleared', 'success');
                console.log('%c‚úì Token cleared', 'color: orange;');
            } catch (e) {
                console.error('Clear error:', e);
            }
        }

        function getToken() {
            // Check memory
            if (STATE.token && STATE.token.length > 20) {
                console.log('Using token from memory');
                return STATE.token;
            }
            
            // Check localStorage
            try {
                const stored = localStorage.getItem(CONFIG.TOKEN_KEY);
                if (stored && stored.length > 20) {
                    console.log('Using token from localStorage');
                    STATE.token = stored;
                    return stored;
                }
            } catch (e) {
                console.error('Token retrieval error:', e);
            }
            
            // Check input
            const input = document.getElementById('tokenInput').value.trim();
            if (input && input.length > 20) {
                console.log('Using token from input');
                return input;
            }
            
            return null;
        }

        function addFromClipboard() {
            const text = document.getElementById('pasteArea').value.trim();
            if (!text) {
                alert('‚ùå Paste some URLs first!');
                return;
            }

            const lines = text.split('\n').filter(l => l.trim());
            let added = 0;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('#')) return;

                let title = '';
                let url = '';

                if (line.includes('|')) {
                    const parts = line.split('|');
                    title = parts[0].trim();
                    url = parts[1].trim();
                } else {
                    url = line;
                    try {
                        const u = new URL(url);
                        title = u.pathname.split('/').pop() || 'Video';
                        title = decodeURIComponent(title);
                    } catch {
                        title = 'Video ' + (STATE.videos.length + added + 1);
                    }
                }

                if (url && url.startsWith('http')) {
                    STATE.videos.push({ title, url, duration: -1 });
                    added++;
                }
            });

            renderTable();
            document.getElementById('pasteArea').value = '';
            alert(`‚úÖ Added ${added} video(s)!\n\nClick "SAVE & UPDATE PLAYLIST" to save.`);
        }

        async function loadVideos() {
            try {
                const url = `https://api.github.com/repos/${CONFIG.GITHUB_USER}/${CONFIG.REPO}/contents/${CONFIG.FILE}?ref=${CONFIG.BRANCH}&_=${Date.now()}`;
                const response = await fetch(url);
                const data = await response.json();
                
                STATE.fileSha = data.sha;
                STATE.videos = JSON.parse(atob(data.content));
                renderTable();
                
                console.log(`‚úì Loaded ${STATE.videos.length} videos`);
            } catch (error) {
                console.error('Load error:', error);
                alert('Error loading videos: ' + error.message);
            }
        }

        function renderTable() {
            const tbody = document.getElementById('videoList');
            tbody.innerHTML = STATE.videos.map((v, i) => `
                <tr>
                    <td><input type="text" value="${escapeHtml(v.title || '')}" onchange="updateVideo(${i}, 'title', this.value)"></td>
                    <td><input type="text" value="${escapeHtml(v.url || '')}" onchange="updateVideo(${i}, 'url', this.value)"></td>
                    <td><button class="btn btn-danger" onclick="deleteVideo(${i})">Delete</button></td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateVideo(index, field, value) {
            STATE.videos[index][field] = value;
        }

        function addRow() {
            STATE.videos.push({ 
                title: 'New Video', 
                url: 'https://example.com/video.mp4', 
                duration: -1 
            });
            renderTable();
        }

        function deleteVideo(index) {
            if (confirm('Delete this video?')) {
                STATE.videos.splice(index, 1);
                renderTable();
            }
        }

        async function saveVideos() {
            const token = getToken();
            
            if (!token) {
                alert('‚ùå NO TOKEN!\n\n1. Paste token in yellow box\n2. Click "SAVE TOKEN"\n3. Try again');
                showStatus('‚ùå Save your token first!', 'error');
                return;
            }

            console.log('Saving videos...');

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${CONFIG.GITHUB_USER}/${CONFIG.REPO}/contents/${CONFIG.FILE}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: 'Update video list',
                            content: btoa(JSON.stringify(STATE.videos, null, 2)),
                            sha: STATE.fileSha,
                            branch: CONFIG.BRANCH
                        })
                    }
                );

                if (response.ok) {
                    alert('‚úÖ SAVED!\n\nPlaylist will update in ~30 seconds.');
                    console.log('%c‚úì Save successful', 'color: green; font-weight: bold;');
                    await loadVideos();
                } else {
                    const error = await response.json();
                    console.error('API error:', error);
                    alert('‚ùå Save failed: ' + (error.message || 'Unknown error'));
                    
                    if (response.status === 401) {
                        showStatus('‚ùå Token invalid! Enter a new token.', 'error');
                        localStorage.removeItem(CONFIG.TOKEN_KEY);
                        STATE.token = null;
                    }
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('‚ùå Network error: ' + error.message);
            }
        }
    </script>
</body>
</html>