<!DOCTYPE html>
<html>
<head>
    <title>M3U Playlist Generator</title>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body { font-family: Arial; max-width: 900px; margin: 50px auto; padding: 20px; }
        h1 { color: #333; }
        .url-box { background: #f0f0f0; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .url-box code { background: #fff; padding: 10px; display: block; word-break: break-all; }
        .token-box { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #ffc107; }
        .token-box input { width: 70%; padding: 8px; margin-right: 10px; }
        .paste-box { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .paste-box textarea { width: 100%; padding: 10px; min-height: 100px; font-family: monospace; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #4CAF50; color: white; }
        .btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .btn:hover { background: #45a049; }
        .btn-secondary { background: #2196F3; }
        .btn-secondary:hover { background: #0b7dda; }
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #da190b; }
        input[type="text"], input[type="password"] { padding: 8px; box-sizing: border-box; }
        .help-text { color: #666; font-size: 0.9em; margin-top: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .version { position: fixed; bottom: 10px; right: 10px; font-size: 0.8em; color: #999; }
    </style>
</head>
<body>
    <h1>üé¨ M3U Playlist Manager</h1>
    
    <div class="url-box">
        <strong>Your M3U Playlist URL:</strong>
        <code>https://wizzzzard333-ctrl.github.io/m3u-playlist/playlist.m3u</code>
    </div>

    <div class="token-box">
        <strong>üîë GitHub Token (Permanently Saved):</strong><br><br>
        <input type="password" id="tokenInput" placeholder="Paste your GitHub token here" style="width: 60%;">
        <button class="btn btn-secondary" onclick="saveToken()">üíæ Save Token</button>
        <button class="btn btn-danger" onclick="clearToken()">üóëÔ∏è Clear</button>
        <div id="tokenStatus" style="margin-top: 10px;"></div>
        <div class="help-text">
            <strong>First time setup:</strong> Get token from <a href="https://github.com/settings/tokens/new" target="_blank">github.com/settings/tokens/new</a><br>
            Select scope: <strong>repo</strong> ‚Üí Generate token ‚Üí Copy ‚Üí Paste above ‚Üí Click "Save Token"
        </div>
    </div>

    <div class="paste-box">
        <strong>üìã Quick Add from Clipboard:</strong><br>
        <textarea id="pasteArea" placeholder="Paste URLs here (one per line)&#10;Example:&#10;https://example.com/video1.mp4&#10;https://example.com/video2.mp4&#10;&#10;Or with titles:&#10;My Video Title | https://example.com/video.mp4"></textarea>
        <button class="btn btn-secondary" onclick="addFromClipboard()">‚ûï Add URLs</button>
        <div class="help-text">Paste one URL per line. Optional: Add title before URL separated by |</div>
    </div>

    <h2>Videos</h2>
    <table id="videoTable">
        <thead>
            <tr>
                <th style="width: 30%;">Title</th>
                <th style="width: 55%;">URL</th>
                <th style="width: 15%;">Action</th>
            </tr>
        </thead>
        <tbody id="videoList"></tbody>
    </table>

    <button class="btn" onclick="addRow()">+ Add Video</button>
    <button class="btn" onclick="saveVideos()">üíæ Save & Update Playlist</button>

    <div class="version">v3.0 - Token Persistent</div>

    <script>
        const GITHUB_USER = 'wizzzzard333-ctrl';
        const REPO = 'm3u-playlist';
        const FILE = 'videos.json';
        const BRANCH = 'main';
        const TOKEN_KEY = 'm3u_gh_token_v3';
        
        let videos = [];
        let fileSha = '';
        let savedToken = null;

        // Initialize on page load
        (function init() {
            console.log('=== M3U Playlist Manager v3.0 ===');
            loadSavedToken();
            loadVideos();
        })();

        function loadSavedToken() {
            try {
                savedToken = localStorage.getItem(TOKEN_KEY);
                console.log('Token check:', savedToken ? 'FOUND' : 'NOT FOUND');
                
                if (savedToken && savedToken.length > 10) {
                    document.getElementById('tokenInput').value = savedToken;
                    showTokenStatus('‚úÖ Token loaded successfully! You can save videos anytime.', 'success');
                    console.log('Token loaded from localStorage');
                } else {
                    showTokenStatus('‚ö†Ô∏è No token saved. Please paste and save your GitHub token above.', 'error');
                    console.log('No valid token found');
                }
            } catch (e) {
                console.error('Error loading token:', e);
                showTokenStatus('‚ùå Error loading token. Please save again.', 'error');
            }
        }

        function showTokenStatus(message, type) {
            const statusDiv = document.getElementById('tokenStatus');
            statusDiv.className = 'status ' + type;
            statusDiv.innerHTML = message;
        }

        function saveToken() {
            try {
                const token = document.getElementById('tokenInput').value.trim();
                
                if (!token || token.length < 10) {
                    showTokenStatus('‚ùå Please enter a valid GitHub token', 'error');
                    return;
                }
                
                localStorage.setItem(TOKEN_KEY, token);
                savedToken = token;
                
                // Verify it was saved
                const verify = localStorage.getItem(TOKEN_KEY);
                if (verify === token) {
                    showTokenStatus('‚úÖ Token PERMANENTLY saved! It will persist across all sessions.', 'success');
                    console.log('Token saved successfully to localStorage with key:', TOKEN_KEY);
                } else {
                    showTokenStatus('‚ùå Failed to save token. Check browser settings.', 'error');
                }
            } catch (e) {
                console.error('Error saving token:', e);
                showTokenStatus('‚ùå Error: ' + e.message, 'error');
            }
        }

        function clearToken() {
            if (confirm('Are you sure you want to clear the saved token?')) {
                try {
                    localStorage.removeItem(TOKEN_KEY);
                    savedToken = null;
                    document.getElementById('tokenInput').value = '';
                    showTokenStatus('‚úÖ Token cleared', 'success');
                    console.log('Token cleared from localStorage');
                } catch (e) {
                    console.error('Error clearing token:', e);
                }
            }
        }

        function getToken() {
            // Priority 1: Use cached token
            if (savedToken && savedToken.length > 10) {
                console.log('Using cached token');
                return savedToken;
            }
            
            // Priority 2: Load from localStorage
            try {
                const stored = localStorage.getItem(TOKEN_KEY);
                if (stored && stored.length > 10) {
                    console.log('Using token from localStorage');
                    savedToken = stored;
                    return stored;
                }
            } catch (e) {
                console.error('Error reading token:', e);
            }
            
            // Priority 3: Get from input field
            const inputToken = document.getElementById('tokenInput').value.trim();
            if (inputToken && inputToken.length > 10) {
                console.log('Using token from input field');
                return inputToken;
            }
            
            console.log('No token available');
            return null;
        }

        function addFromClipboard() {
            const text = document.getElementById('pasteArea').value.trim();
            if (!text) {
                alert('‚ùå Please paste some URLs first');
                return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            let addedCount = 0;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                let title = '';
                let url = '';

                if (line.includes('|')) {
                    const parts = line.split('|');
                    title = parts[0].trim();
                    url = parts[1].trim();
                } else {
                    url = line;
                    try {
                        const urlObj = new URL(url);
                        const pathname = urlObj.pathname;
                        title = pathname.split('/').pop() || 'Video';
                    } catch {
                        title = 'Video ' + (videos.length + addedCount + 1);
                    }
                }

                if (url) {
                    videos.push({ 
                        title: title, 
                        url: url, 
                        duration: -1 
                    });
                    addedCount++;
                }
            });

            renderTable();
            document.getElementById('pasteArea').value = '';
            alert(`‚úÖ Added ${addedCount} video(s)!\n\nClick "Save & Update Playlist" to save changes.`);
        }

        async function loadVideos() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${FILE}?ref=${BRANCH}&t=${Date.now()}`);
                const data = await response.json();
                fileSha = data.sha;
                videos = JSON.parse(atob(data.content));
                renderTable();
                console.log('Loaded', videos.length, 'videos');
            } catch (error) {
                console.error('Error loading videos:', error);
            }
        }

        function renderTable() {
            const tbody = document.getElementById('videoList');
            tbody.innerHTML = videos.map((video, index) => `
                <tr>
                    <td><input type="text" value="${(video.title || '').replace(/"/g, '&quot;')}" onchange="updateVideo(${index}, 'title', this.value)"></td>
                    <td><input type="text" value="${(video.url || '').replace(/"/g, '&quot;')}" onchange="updateVideo(${index}, 'url', this.value)"></td>
                    <td><button class="btn btn-danger" onclick="deleteVideo(${index})">Delete</button></td>
                </tr>
            `).join('');
        }

        function updateVideo(index, field, value) {
            videos[index][field] = value;
        }

        function addRow() {
            videos.push({ title: 'New Video', url: 'https://example.com/video.mp4', duration: -1 });
            renderTable();
        }

        function deleteVideo(index) {
            if (confirm('Delete this video?')) {
                videos.splice(index, 1);
                renderTable();
            }
        }

        async function saveVideos() {
            const token = getToken();
            
            if (!token) {
                alert('‚ùå No GitHub token found!\n\nPlease:\n1. Paste your token in the yellow box\n2. Click "Save Token"\n3. Try again');
                return;
            }

            console.log('Saving with token...');

            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${FILE}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'Update video list',
                        content: btoa(JSON.stringify(videos, null, 2)),
                        sha: fileSha,
                        branch: BRANCH
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Videos saved successfully!\n\nPlaylist will update in ~30 seconds.');
                    await loadVideos();
                } else {
                    const error = await response.json();
                    console.error('Save error:', error);
                    alert('‚ùå Error saving: ' + (error.message || 'Unknown error'));
                    
                    if (response.status === 401) {
                        showTokenStatus('‚ùå Token is invalid or expired. Please enter a new token.', 'error');
                        localStorage.removeItem(TOKEN_KEY);
                        savedToken = null;
                    }
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('‚ùå Network error: ' + error.message);
            }
        }
    </script>
</body>
</html>